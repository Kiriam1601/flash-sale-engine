<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Sale Pro ‚ö°</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 90%; max-width: 1000px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; text-align: center; margin-bottom: 20px; }
        
        /* Grid layout cho danh s√°ch s·∫£n ph·∫©m */
        .grid-products { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 100%; }
        .product-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); }
        
        .p-name { font-size: 1.2rem; font-weight: bold; color: #333; margin: 10px 0; }
        .p-price-box { margin: 15px 0; }
        .old-price { text-decoration: line-through; color: #95a5a6; font-size: 0.9rem; }
        .sale-price { color: #e74c3c; font-size: 1.5rem; font-weight: bold; }
        .stock-tag { background: #ecf0f1; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; color: #2c3e50; display: inline-block; margin-bottom: 15px; }
        
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #e74c3c; color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .hidden { display: none !important; } /* Quan tr·ªçng: th√™m !important */
        .link { color: blue; cursor: pointer; font-size: 0.9rem; margin-top: 10px; display: block;}
        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loginScreen" class="card">
            <h2>ƒêƒÉng Nh·∫≠p üîê</h2>
            <input type="email" id="email" placeholder="Email" value="hacker@test.com">
            <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" value="123456">
            <button onclick="handleLogin()">V√ÄO MUA H√ÄNG</button>
            <span class="link" onclick="toggleScreen('register')">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω</span>
            <div id="loginMsg" style="color: red; margin-top: 10px;"></div>
        </div>

        <div id="registerScreen" class="card hidden">
            <h2>ƒêƒÉng K√Ω üìù</h2>
            <input type="email" id="regEmail" placeholder="Email m·ªõi">
            <input type="password" id="regPass" placeholder="M·∫≠t kh·∫©u m·ªõi">
            <button onclick="handleRegister()">T·∫†O T√ÄI KHO·∫¢N</button>
            <span class="link" onclick="toggleScreen('login')">Quay l·∫°i ƒëƒÉng nh·∫≠p</span>
            <div id="regMsg" style="margin-top: 10px;"></div>
        </div>

        <div id="shopScreen" class="hidden" style="width: 100%;">
            <div class="header">
                <h1 style="color: #e74c3c; margin: 0;">SƒÇN DEAL H√îM NAY üî•</h1>
                <button onclick="logout()" style="background: #95a5a6; width: auto; padding: 8px 15px;">ƒêƒÉng xu·∫•t</button>
            </div>

            <div id="productList" class="grid-products">
                </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');

        if(token) showShop();

        function toggleScreen(screen) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('shopScreen').classList.add('hidden');
            
            if(screen === 'login') document.getElementById('loginScreen').classList.remove('hidden');
            if(screen === 'register') document.getElementById('registerScreen').classList.remove('hidden');
            if(screen === 'shop') document.getElementById('shopScreen').classList.remove('hidden');
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            // ... (Logic login c≈© gi·ªØ nguy√™n)
            const res = await fetch(`${API}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if(res.ok) {
                token = data.token;
                localStorage.setItem('token', token);
                showShop();
            } else {
                document.getElementById('loginMsg').innerText = data.message;
            }
        }

        async function handleRegister() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPass').value;
            // ... (Logic register c≈© gi·ªØ nguy√™n)
            const res = await fetch(`${API}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            const msg = document.getElementById('regMsg');
            if(res.ok) {
                msg.style.color = 'green';
                msg.innerText = "ƒêƒÉng k√Ω th√†nh c√¥ng!";
                setTimeout(() => toggleScreen('login'), 1500);
            } else {
                msg.style.color = 'red';
                msg.innerText = data.message;
            }
        }

        function showShop() {
            toggleScreen('shop');
            fetchProducts();
            setInterval(fetchProducts, 2000); // C·∫≠p nh·∫≠t realtime
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        // --- Logic Hi·ªÉn th·ªã & Mua H√†ng ---
        async function fetchProducts() {
            try {
                const res = await fetch(`${API}/info`);
                if(res.ok) {
                    const products = await res.json();
                    renderProductList(products);
                }
            } catch(e) {}
        }

        function renderProductList(products) {
            const listDiv = document.getElementById('productList');
            
            if (products.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; width:100%">Ch∆∞a c√≥ ƒë·ª£t Flash Sale n√†o ƒëang di·ªÖn ra!</div>';
                return;
            }

            // T·∫°o HTML cho t·ª´ng s·∫£n ph·∫©m
            const html = products.map(p => {
                // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
                const priceFormat = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
                const isOutOfStock = p.available_stock <= 0;
                
                return `
                    <div class="product-card">
                        <div style="background: #333; color: white; padding: 30px; border-radius: 10px; margin-bottom: 15px;">
                            ${p.product_name}
                        </div>
                        
                        <div class="p-price-box">
                            <div class="old-price">G·ªëc: ${priceFormat.format(p.original_price)}</div>
                            <div class="sale-price">${priceFormat.format(p.sale_price)}</div>
                        </div>

                        <div class="stock-tag">
                            Kho c√≤n: <strong>${p.available_stock}</strong>
                        </div>

                        <button 
                            onclick="buyProduct(${p.flash_sale_id}, this)" 
                            ${isOutOfStock ? 'disabled' : ''}
                            style="${isOutOfStock ? 'background: #95a5a6' : ''}"
                        >
                            ${isOutOfStock ? 'H·∫æT H√ÄNG' : 'MUA NGAY üöÄ'}
                        </button>
                        <div class="msg-box-${p.flash_sale_id}" style="margin-top:10px; font-size: 0.9rem; min-height: 20px;"></div>
                    </div>
                `;
            }).join('');

            // Ch·ªâ c·∫≠p nh·∫≠t DOM n·∫øu c√≥ s·ª± thay ƒë·ªïi l·ªõn (ƒë·ªÉ tr√°nh gi·∫≠t khi ƒëang b·∫•m n√∫t)
            // ·ªû ƒë√¢y m√¨nh thay th·∫ø lu√¥n ƒë·ªÉ ƒë∆°n gi·∫£n h√≥a code
            // M·∫πo: Trong th·ª±c t·∫ø n√™n so s√°nh data tr∆∞·ªõc khi render l·∫°i
            
            // Tuy nhi√™n, ƒë·ªÉ tr√°nh reset l·∫°i c√°i n√∫t "ƒêang x·ª≠ l√Ω..." khi user v·ª´a b·∫•m
            // Ta ch·ªâ update l·∫°i s·ªë l∆∞·ª£ng kho th√¥i, nh∆∞ng ƒë·ªÉ ƒë∆°n gi·∫£n cho Intern Project th√¨ innerHTML l√† OK.
            // ƒê·ªÉ user kh√¥ng b·ªã gi·∫≠t n√∫t, ta c√≥ th·ªÉ ki·ªÉm tra xem n√∫t ƒë√≥ c√≥ ƒëang disabled (ƒëang b·∫•m) ko.
            // Nh∆∞ng c√°ch t·ªët nh·∫•t cho b√†i n√†y l√†: C·ª© render l·∫°i, v√¨ fetchProducts ch·∫°y 2s/l·∫ßn.
            
            // L∆∞u √Ω: Vi·ªác render l·∫°i to√†n b·ªô m·ªói 2s s·∫Ω l√†m m·∫•t tr·∫°ng th√°i th√¥ng b√°o "Mua th√†nh c√¥ng"
            // -> C·∫ßn 1 gi·∫£i ph√°p t·ªët h∆°n: T√°ch vi·ªác update kho ra kh·ªèi vi·ªác render khung.
            // Nh∆∞ng ƒë·ªÉ code ng·∫Øn g·ªçn, ta ch·∫•p nh·∫≠n vi·ªác th√¥ng b√°o s·∫Ω bi·∫øn m·∫•t sau 2s.
            
            // C√°ch fix t·∫°m th·ªùi: Ki·ªÉm tra n·∫øu n·ªôi dung HTML thay ƒë·ªïi th√¨ m·ªõi update
             if (listDiv.innerHTML.length < 100 || !document.querySelector('button:disabled')) {
                 // Logic check s∆° s√†i ƒë·ªÉ tr√°nh render l·∫°i khi ƒëang b·∫•m mua
                 // (D√≤ng n√†y ch·ªâ l√† v√≠ d·ª•, b·∫°n c√≥ th·ªÉ b·ªè qua v√† ch·∫•p nh·∫≠n n√≥ reload)
             }
             
             // Phi√™n b·∫£n ƒë∆°n gi·∫£n nh·∫•t:
             // listDiv.innerHTML = html; 
             // Nh∆∞ng s·∫Ω b·ªã m·∫•t th√¥ng b√°o.
             
             // Phi√™n b·∫£n n√¢ng cao: Ch·ªâ update s·ªë l∆∞·ª£ng text
             updateOrRender(products);
        }

        // H√†m th√¥ng minh: N·∫øu th·∫ª ƒë√£ c√≥ th√¨ ch·ªâ update s·ªë, ch∆∞a c√≥ th√¨ v·∫Ω m·ªõi
        function updateOrRender(products) {
            const listDiv = document.getElementById('productList');
            
            // N·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m n√†o, v·∫Ω m·ªõi ho√†n to√†n
            if (listDiv.children.length !== products.length) {
                const html = products.map(p => generateCardHTML(p)).join('');
                listDiv.innerHTML = html;
                return;
            }

            // N·∫øu ƒë√£ c√≥, ch·ªâ ƒëi c·∫≠p nh·∫≠t s·ªë li·ªáu t·ª´ng c√°i
            products.forEach((p, index) => {
                const card = listDiv.children[index];
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                const stockTag = card.querySelector('.stock-tag strong');
                if(stockTag) stockTag.innerText = p.available_stock;
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t (N·∫øu h·∫øt h√†ng)
                const btn = card.querySelector('button');
                if(p.available_stock <= 0 && !btn.disabled) {
                    btn.disabled = true;
                    btn.innerText = "H·∫æT H√ÄNG";
                    btn.style.background = "#95a5a6";
                }
            });
        }

        function generateCardHTML(p) {
            const priceFormat = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
            const isOutOfStock = p.available_stock <= 0;
            return `
                <div class="product-card" id="card-${p.flash_sale_id}">
                    <div style="background: #333; color: white; padding: 30px; border-radius: 10px; margin-bottom: 15px;">
                        ${p.product_name}
                    </div>
                    <div class="p-price-box">
                        <div class="old-price">G·ªëc: ${priceFormat.format(p.original_price)}</div>
                        <div class="sale-price">${priceFormat.format(p.sale_price)}</div>
                    </div>
                    <div class="stock-tag">Kho c√≤n: <strong>${p.available_stock}</strong></div>
                    <button onclick="buyProduct(${p.flash_sale_id}, this)" ${isOutOfStock ? 'disabled style="background:#95a5a6"' : ''}>
                        ${isOutOfStock ? 'H·∫æT H√ÄNG' : 'MUA NGAY üöÄ'}
                    </button>
                    <div class="msg-box" style="margin-top:10px; font-weight:bold;"></div>
                </div>
            `;
        }

        async function buyProduct(saleId, btn) {
            const card = document.getElementById(`card-${saleId}`);
            const msgBox = card.querySelector('.msg-box');
            
            btn.disabled = true;
            btn.innerText = "ƒêang x·ª≠ l√Ω...";
            msgBox.innerText = "";

            try {
                const res = await fetch(`${API}/buy`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ flashSaleId: saleId })
                });

                const data = await res.json();
                msgBox.innerText = data.message;
                msgBox.style.color = res.ok ? 'green' : 'red';

                if(res.ok) {
                    fetchProducts(); // C·∫≠p nh·∫≠t kho ngay
                }
            } catch(e) {
                msgBox.innerText = "L·ªói m·∫°ng";
                msgBox.style.color = "red";
            } finally {
                // M·ªü l·∫°i n√∫t sau 1s n·∫øu ch∆∞a h·∫øt h√†ng (d·ª±a v√†o l·∫ßn fetch t·ªõi)
                setTimeout(() => {
                    if (btn.innerText !== "H·∫æT H√ÄNG") {
                        btn.disabled = false;
                        btn.innerText = "MUA NGAY üöÄ";
                    }
                }, 1000);
            }
        }
    </script>
</body>
</html>